%% 18-08-22 exp 1
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220818'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[1 2 3 4 5 6 7 8 9 10 11];
objdist=[0 2 4 6 8 10 12 14 16 20 inf];
OP=0;
%% 22-08-22 exp 1
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220822'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[1 2 3 4 5 6 7 8 9 10 11];
objdist=[0 2 4 6 8 10 12 14 16 20 inf];
OP=1;
%% 22-08-22 exp 2
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220822'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[12 13 14 15 16 17 18 19 20 21];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 22-08-22 exp 3
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220822'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[22 23 24 25 26 27 28 29 30 31];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 22-08-22 exp 4
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220822'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[32 33 34 35 36 37 38 39 40 41];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 24-08-22 exp 1
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220824'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[1 2 3 4 5 6 7 8 9 10];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 24-08-22 exp 2
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220824'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[11:20];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 24-08-22 exp 3
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220824'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[21:30];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 24-08-22 exp 4
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220824'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[31:41];
objdist=[0 2 4 6 8 10 12 16 20 24 inf];
OP=1;
%% 24-08-22 exp 5
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220824'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[42 43 44 45 46 47 48 49 50 52];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 24-08-22 exp 6
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220824'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[53:62];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;

%% 24-08-22 exp 7
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220824'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[63:72];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 24-08-22 exp 8
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220824'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[73:82];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;

%% 30-08-22 exp 1
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[1:10];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;

%% 30-08-22 exp 2
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[11:20];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 30-08-22 exp 3
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[21:29];
objdist=[0 2 4 6 8 10 12 16 20];
OP=1;
%% 30-08-22 exp 4
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[30:39];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 30-08-22 exp 5
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[40:49];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 30-08-22 exp 6
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[50:59];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 30-08-22 exp 7
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[60:68];
objdist=[0 2 4 6 8 10 12 16 20];
OP=1;
%% 30-08-22 exp 8
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[69:78];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 30-08-22 exp 9
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220830'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[79:88];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=1;
%% 06-09-22 exp 1
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[1:10];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 06-09-22 exp 2
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[11:20];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 06-09-22 exp 3
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[21:30];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 06-09-22 exp 4
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[31:40];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 06-09-22 exp 5
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[41:50];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;

%% 06-09-22 exp 6
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[51:60];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;

%% 06-09-22 exp 7
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[61:70];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;

%% 06-09-22 exp 8
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[71:80];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;

%% 06-09-22 exp 9
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[81:90];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 06-09-22 exp 10
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220906'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[91:100];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 08-09-22 exp 1
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[1:10];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 08-09-22 exp 2
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[11:20];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 08-09-22 exp 3
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[21:30];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 08-09-22 exp 4
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[31:40];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 08-09-22 exp 5
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[41:50];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;

%% 08-09-22 exp 6
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[51:60];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;

%% 08-09-22 exp 7
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[61:70];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;

%% 08-09-22 exp 8
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[71:80];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;

%% 08-09-22 exp 9
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[81:90];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;
%% 08-09-22 exp 10
clearvars; cd('D:\KIT'); addpath('D:\KIT3'); addpath('D:\KIT2');
direfinal=uigetdir('Z:\locker\Fede\220908'); %3D data
files2=dir([direfinal, '\*.mat']);
fileN=[91:100];
objdist=[0 2 4 6 8 10 12 16 20 inf];
OP=2;



%%
Valecho1=[]; Valecho2=[]; Val=[]; Val2=[]; Valraw1=[]; Valraw2=[];
samplerate1=20000; AUX11=[];
tic
for i=1:size(fileN,2)
    load([direfinal, '\', files2(fileN(i)).name])
    if OP==0
        EODtime=eval([files2(fileN(i)).name(1:end-4),'_Ch3.values']);
        LFP=eval([files2(fileN(i)).name(1:end-4),'_Ch2.values']);
    else
        EODtime=eval(['V',files2(fileN(i)).name(1:end-4),'_Ch3.values']);
        LFP=eval(['V',files2(fileN(i)).name(1:end-4),'_Ch2.values']);     
    end
    % Mfish=eval(['V',files2(vidnum(j)).name(1:end-4),'_Ch5.values']);
    
    if OP==0
        [value3,sample3]=findpeaks(EODtime ,'MINPEAKHEIGHT',0.5,'MINPEAKDISTANCE',90);
        [value4,sample4]=findpeaks(EODtime ,'MINPEAKHEIGHT',4.5,'MINPEAKDISTANCE',200);
    elseif OP==1
        [value3,sample3]=findpeaks(LFP ,'MINPEAKHEIGHT',0.16,'MINPEAKDISTANCE',90);
        [value4,sample4]=findpeaks(LFP ,'MINPEAKHEIGHT',0.55,'MINPEAKDISTANCE',200);
    elseif OP==2
        [value3,sample3]=findpeaks(LFP ,'MINPEAKHEIGHT',0.055,'MINPEAKDISTANCE',90);
        a=1; sample4=[];
        for k=1:size(sample3,1)
            try
                if max(LFP(sample3(k)+120:sample3(k)+281))>=0.013
                    sample4(a,1)=sample3(k);
                    a=a+1;
                end
            end
        end
    end
    %figure; subplot(2,1,1); plot((1:1:size(EODtime,1))/samplerate1,EODtime);  hold on; plot(sample3/samplerate1,1,'or'); hold on; plot(sample4/samplerate1,1,'ob');
    %figure; subplot(2,1,1); plot((1:1:size(EODtime,1))/samplerate1,LFP);  hold on; plot(sample3/samplerate1,0.01,'or'); hold on; plot(sample4/samplerate1,0.01,'ob');
    
    LFPAm_1=[]; LFPAm_1echo=[]; LFPAm_2=[]; LFPAm_2echo=[]; LFPraw_1=[]; LFPraw_2=[];
    
    for k=1:size(sample4,1)
        sample3(sample3(:)==sample4(k))=[];
    end
    a=1; b=1;
    for j=1:size(sample3,1)
        [k,dist] = dsearchn(sample3(j),sample4); [val,idx]=min(dist);
        AUX=[];
        if sample3(j)<=sample4(idx)
            try
                AUX=sample3(j)-sample4(idx-1);
            catch
                AUX=500;
            end
        else
            AUX=sample3(j)-sample4(idx);
        end
        
        if AUX<=300
            LFPAm_1echo(a)=min(LFP(sample3(j)+20:sample3(j)+100)); a=a+1;
        else
            try
                LFPAm_1(b)=min(LFP(sample3(j)+20:sample3(j)+100));
                LFPraw_1(1:81,b)=(LFP(sample3(j)+20:sample3(j)+100));
                b=b+1;
            end
        end
        
    end
    
    
    a=1; b=1;
    for j=1:size(sample4,1)
        [k,dist] = dsearchn(sample4(j),sample3); [val,idx]=min(dist);
        AUX=[];
        if sample4(j)<=sample3(idx)
            try
                AUX=sample4(j)-sample3(idx-1);
            catch
                AUX=500;
            end
        else
            AUX=sample4(j)-sample3(idx);
        end
        
        if AUX<=300
            LFPAm_2echo(a)=min(LFP(sample4(j)+20:sample4(j)+100)); a=a+1;
        else
            try
                LFPAm_2(b)=min(LFP(sample4(j)+20:sample4(j)+100));
                LFPraw_2(1:81,b)=(LFP(sample4(j)+20:sample4(j)+100));
                b=b+1;
%             catch
%                 LFPAm_2(b)=min(LFP(sample4(j)+20:sample4(j)+50));
%                 LFPraw_2(1:81,b)=nan;
%                 b=b+1;
            end
        end
    end
    
    Valecho1(i)=nanmedian(LFPAm_1echo);
    Valecho2(i)=nanmedian(LFPAm_2echo);
    
    Val1(i)=nanmedian(LFPAm_1);
    Val2(i)=nanmedian(LFPAm_2);
    
    Valraw1(1:81,i)=nanmedian(LFPraw_1,2);
    Valraw2(1:81,i)=nanmedian(LFPraw_2,2);
   
    a=1; M1=[];
    for z=1:size(sample3,1) %calculate IDI with fish and mimic
        try
            [idx2,idx]=min(abs(sample4-sample3(z)));
            if sample4(idx)>=sample3(z)
                M1(a,1)=(sample4(idx-1)-sample3(z))/samplerate1;
                M1(a,2)=(sample4(idx)-sample3(z))/samplerate1;
            else
                M1(a,1)=(sample4(idx)-sample3(z))/samplerate1;
                M1(a,2)=(sample4(idx+1)-sample3(z))/samplerate1;
            end
            a=a+1;
        end
    end
    
    
    AUX111=reshape(M1,[1,size(M1,1)*size(M1,2)]);
    AUX11=[AUX11,AUX111];
    
end
toc
%% figures raw data
figure; 
axes('ColorOrder',flipud(brewermap(size(Valraw1,2)+1,'reds')),'NextPlot','replacechildren')
plot(Valraw1(:,1:end-1),'linewidth',4); 

figure;
axes('ColorOrder',flipud(brewermap(size(Valraw2,2)+1,'blues')),'NextPlot','replacechildren')
plot(Valraw2(:,1:end-1),'linewidth',4); 



figure; h1=histogram(AUX11,1000); h1.Normalization = 'probability'; h1.EdgeAlpha= 0; xlim([-0.3 0.3]);
%%
figure; 
subplot(2,2,1);
        f = fit(objdist(1:end-1)',1-abs(Val1(1:end-1)./Val1(end))','exp2');
        plot(f,objdist(1:end-1),1-abs(Val1(1:end-1)./Val1(end)))
subplot(2,2,2); 
        f = fit(objdist(1:end-1)',1-abs(Val2(1:end-1)./Val2(end))','exp2');
        plot(f,objdist(1:end-1),1-abs(Val2(1:end-1)./Val2(end)))
        
%[1*(1-abs(Val1(1:end-1)./Val1(end)))' 1-abs(Val2(1:end-1)./Val2(end))' ]            
%%        
% subplot(2,2,3); 
%         f = fit(objdist(1:end-1)',1-abs(Valecho1(1:end-1)./Valecho1(end))','exp2');
%         plot(f,objdist(1:end-1),1-abs(Valecho1(1:end-1)./Valecho1(end)))
% subplot(2,2,4); 
%         f = fit(objdist(1:end-1)',1-abs(Valecho2(1:end-1)./Valecho2(end))','exp2');
%         plot(f,objdist(1:end-1),1-abs(Valecho2(1:end-1)./Valecho2(end)))

figure; 
subplot(2,2,1);
        f = fit(objdist(1:end-1)',(Val1(1:end-1)-Val1(end))','exp2');
        plot(f,objdist(1:end-1),Val1(1:end-1)-Val1(end))
subplot(2,2,2); 
        f = fit(objdist(1:end-1)',(Val2(1:end-1)-Val2(end))','exp2');
        plot(f,objdist(1:end-1),Val2(1:end-1)-Val2(end))
subplot(2,2,3); 
        f = fit(objdist(1:end-1)',(Valecho1(1:10)-Valecho1(end))','exp2');
        plot(f,objdist(1:end-1),Valecho1(1:end-1)-Valecho1(end))
subplot(2,2,4); 
        f = fit(objdist(1:end-1)',(Valecho2(1:10)-Valecho2(end))','exp2');
        plot(f,objdist(1:end-1),Valecho2(1:end-1)-Valecho2(end))
        
 [1*(1-abs(Val1(1:end-1)./Val1(end-2)))' 1-abs(Val2(1:end-1)./Val2(end-2))' ]      
        
        
figure; 
subplot(2,2,1);
        %f = fit(objdist(1:end-1)',-1.28+abs(Val1(1:end-1)./Val1(end))','exp2');
        ft = fittype('L + (U-L)/(1 + exp(-4*log(3)*(x-xmid)/xscale80))','indep','x');
        f = fit(objdist(1:end-1)',-1.28+abs(Val1(1:end-1)./Val1(end))',ft);
        
        plot(f,objdist(1:end-1),-1.28+abs(Val1(1:end-1)./Val1(end)))
subplot(2,2,2); 
        f = fit(objdist(1:end-1)',-1+abs(Val2(1:end-1)./Val2(end))','exp2');
        plot(f,objdist(1:end-1),-1+abs(Val2(1:end-1)./Val2(end)))
subplot(2,2,3); 
        f = fit(objdist(1:end-1)',-1+abs(Valecho1(1:end-1)./Valecho1(end))','exp2');
        plot(f,objdist(1:end-1),-1+abs(Valecho1(1:end-1)./Valecho1(end)))
subplot(2,2,4); 
        f = fit(objdist(1:end-1)',-1+abs(Valecho2(1:end-1)./Valecho2(end))','exp2');
        plot(f,objdist(1:end-1),-1+abs(Valecho2(1:end-1)./Valecho2(end)))
%% exp 1
h1 = findobj(subplot(2,2,1),'Type','line');
y1 = h1(2).YData';

h2 = findobj(subplot(2,2,2),'Type','line');
y2 = h2(2).YData';

clear all;

A=[0.146496815	0.268361582	0.104166667	0.332894737	0.320967742	0.486021505	0.38585209	0.370134466	0.832950192	0.529411765
0.164012739	0.175847458	0.045698925	0.196052632	0.179032258	0.36344086	0.36977492	0.133757962	0.531609195	0.418685121
0.068471338	0.122881356	0.053763441	0.105263158	0.006451613	0.251612903	0.180868167	0.0502477	0.264367816	0.228373702
0.046178344	0.101694915	-0.000672043	0.047368421	-0.019354839	0.247311828	0.110128617	0.044585987	0.251915709	0.099192618
0.044585987	0.075564972	-0.008064516	0.040789474	-0.041935484	0.156989247	0.060289389	0.026185421	0.164750958	0.046136101
0.01910828	0.049435028	0.000672043	0.002631579	-0.040322581	0.139784946	0.18488746	0.021939137	0.103448276	0.012687428
0.01433121	0.028248588	0.002688172	0.006578947	0.019354839	0.111827957	0.078778135	0.014861996	0.028735632	0.023644752
0.006369427	0.021186441	-0.00672043	0.001315789	0.006451613	0.04516129	0.041800643	0.000707714	0.003831418	0.005767013
0	0	-0.004032258	0	0	0	0	0	0	0.006920415
];

B=[1.385964912	0.526354319	0.604693141	0.698826597	0.404864092	0.65	0.388850654	0.390277778	0.621478873	0.413940256
1.074561404	0.266471449	0.559566787	0.397653194	0.276108727	0.65	0.194769443	0.166666667	0.593309859	0.142958748
1.026315789	0.161054173	0.277075812	0.134289439	0.020028612	0.526923077	0.069511356	0.072222222	0.455985915	0.083926031
0.403508772	0.134699854	0.092057762	0.014341591	-0.037911302	0.130769231	0.039229181	0.065277778	0.035211268	0.065433855
0.157894737	0.071742313	0.02166065	0.01303781	-0.031473534	0.067307692	-0.006194081	0.047222222	0.065140845	0.017069701
0.048245614	0.039531479	-0.054151625	0.029986962	-0.005722461	0.05	-0.015829319	0.044444444	0.001760563	0.00284495
0.039473684	0.008784773	-0.066787004	0.026075619	-0.00286123	0.029807692	-0.021335169	0.029166667	-0.038732394	-0.020625889
-0.01754386	-0.002928258	-0.039711191	0.001303781	-0.001430615	0.046153846	-0.008947006	-0.004166667	-0.012323944	-0.001422475
0	0	0	0.001303781	0	0	0	0	0	-0.001422475
];

xdist=[0 2	4	6	8	10	12	14	18	20];
ydist=[0 2 4 6 8 10 12 16 20];


w     = 3;   % Size of the sliding window (same number of cols and rows in this case)
% Extrapolate values for current window
[Nr,Nc] = size(A);
Nextra  = 0.5*(w-1);
Ap      = interp2(1:Nc,1:Nr,A,-Nextra+1:Nc+Nextra,(-Nextra+1:Nr+Nextra).','makima');    % 2D extrapolation must use 'spline' or 'makima' interpolation
% Smooth data with sliding window
H  = ones(w)./w^2;                      % The 2D averaging filter
SDS  = filter2(H,Ap,'valid'); 

Ap      = interp2(1:Nc,1:Nr,B,-Nextra+1:Nc+Nextra,(-Nextra+1:Nr+Nextra).','makima');    % 2D extrapolation must use 'spline' or 'makima' interpolation
SDS2  = filter2(H,Ap,'valid'); 

 figure; 
 ax1=subplot(2,1,1); contourf(xdist,ydist,SDS,100,'edgecolor','none'); axis equal; colormap(ax1,brewermap([],'Blues')); 
 hold on; contour(xdist,ydist,SDS,[0.04 0.05],'LineColor', 'k');
 
 %caxis([0 max(max(SDS))]);
 ax2=subplot(2,1,2); contourf(xdist,ydist,SDS2,100,'edgecolor','none'); axis equal; colormap(ax2,brewermap([],'Reds')); %caxis([min() max(max(SDS2))]);
 hold on; contour(xdist,ydist,SDS2,[0.04 0.05],'LineColor', 'k');



%%

h1 = findobj(subplot(2,2,1),'Type','line');
y1 = h1(2).YData';

h2 = findobj(subplot(2,2,2),'Type','line');
y2 = h2(2).YData';
%% exp 2
clear all;

A=[0.070640177	0.050880626	0.075718016	0.1758	0.156881617	0.214659686	0.4115	0.4161	0.081427264
0.094922737	0.094922737	0.075718016	0.1229	0.090471607	0.162303665	0.2196	0.3764	0.070448307
0.118101545	0.050880626	0.097911227	0.0784	0.060635226	0.123036649	0.1506	0.2087	0.057639524
0.002207506	0.050880626	0.092689295	0.0508	0.024061598	0.066317627	0.0916	0.137	0.039341263
0.024282561	0.050880626	0.020887728	0.0265	0.049085659	0.033158813	0.0514	0.0576	0.021043001
0.023178808	0.042074364	0.023498695	0.0169	0.051010587	0.022687609	0.0326	0.0269	0.015553522
0.033112583	0.025440313	0.052219321	0.0095	0.033686237	0.022687609	0.027	0.0141	0.005489478
0.004415011	0.017612524	0.03002611	0.0042	0.016361886	0.010471204	0.0088	0.0077	0.008234218
0.024282561	0.001956947	0.018276762	0	0.006737247	0	0	0	0.004574565
];

B=[0.6279	0.507042254	0.5853	0.113348677	0.165424739	0.3417	0.411864407	0.648241206	0.062589928
0.4628	0.330985915	0.5559	0.109321059	0.156482861	0.1486	0.208474576	0.527638191	0.071942446
0.3049	0.323943662	0.3588	0.086306099	0.126676602	0.0417	0.145762712	0.148241206	0.102158273
0.1543	0.211267606	0.0618	0.070195627	0.059612519	-0.0056	0.075423729	-0.060301508	-0.060301508
0.0454	0.105633803	0.0588	0.062140391	0.031296572	-0.0208	0.007627119	-0.060301508	-0.060301508
-0.0054	0.105633803	0.0353	0.047180667	0.029806259	-0.0285	-0.016949153	-0.16080402	-0.16080402
-0.0018	0.281690141	0.0132	0.024165708	0.011922504	-0.0167	-0.011864407	-0.396984925	-0.034964029
0	-0.014084507	0.0029	0.001726122	-0.005961252	0	0	-0.386934673	-0.030215827
0.0526	0	0	-0.008055236	-0.005216095	0.0236	0	-0.346733668	0
];

xdist=[0	2	4	6	8	10	12	16	20];
ydist=[0 2 4 6 8 10 12 16 20];


w     = 3;   % Size of the sliding window (same number of cols and rows in this case)
% Extrapolate values for current window
[Nr,Nc] = size(A);
Nextra  = 0.5*(w-1);
Ap      = interp2(1:Nc,1:Nr,A,-Nextra+1:Nc+Nextra,(-Nextra+1:Nr+Nextra).','makima');    % 2D extrapolation must use 'spline' or 'makima' interpolation
% Smooth data with sliding window
H  = ones(w)./w^2;                      % The 2D averaging filter
SDS  = filter2(H,Ap,'valid'); 

Ap      = interp2(1:Nc,1:Nr,B,-Nextra+1:Nc+Nextra,(-Nextra+1:Nr+Nextra).','makima');    % 2D extrapolation must use 'spline' or 'makima' interpolation
SDS2  = filter2(H,Ap,'valid'); 

 figure; 
 ax1=subplot(2,1,1); contourf(xdist,ydist,atan(SDS),1000,'edgecolor','none'); axis equal; colormap(ax1,brewermap([],'Blues')); 
 hold on; contour(xdist,ydist,SDS,[0.04 0.05],'LineColor', 'k');
 
 %caxis([0 max(max(SDS))]);
 ax2=subplot(2,1,2); contourf(xdist,ydist,atan(SDS2),1000,'edgecolor','none'); axis equal; colormap(ax2,brewermap([],'Reds')); %caxis([min() max(max(SDS2))]);
 hold on; contour(xdist,ydist,SDS2,[0.04 0.05],'LineColor', 'k');

%% exp 3
clear all;

A=[0.41440678	0.366956522	0.313531353	0.402173913	0.107628004	0.53602812	0.671875	0.057823129	0.301104972	0.569573284
0.223728814	0.234782609	0.099009901	0.080163043	0.065830721	0.398945518	0.569444444	0.011337868	0.174033149	0.257884972
-0.011864407	0.102608696	0.02970297	0.054347826	0.038662487	0.184534271	0.225694444	-0.009070295	-0.038674033	0.072356215
-0.090677966	0.074782609	-0.00660066	0.054347826	0.024033438	0.087873462	0.118055556	-0.003968254	-0.082872928	0.048237477
-0.137288136	0.043478261	-0.001650165	0.04076087	0.004179728	0.056239016	-0.041666667	0	0.044889503	0.029684601
0	0.026086957	-0.00990099	-0.027173913	-0.009404389	0.043936731	-0.095486111	0.003401361	-0.10359116	0.012987013
-0.003389831	0.012173913	-0.004125413	-0.027173913	0.004179728	0.043936731	-0.071180556	0	0.052486188	0.014842301
-0.006779661	0	-0.00330033	-0.027173913	0.00522466	0.029876977	-0.032118056	0	0.027624309	0.005565863
-0.015254237	-0.010434783	-0.004950495	-0.020380435	0	0.017574692	0	0	0.026243094	0.009276438
];

B=[0.771523179	0.653206651	0.386824324	0.51744186	0.199588477	0.595724907	0.704590818	-0.004264392	0.08125	nan
0.771523179	0.657957245	0.135135135	-0.061046512	0.170781893	0.464684015	0.425149701	0.151385928	0.06875	nan
0.715231788	0.636579572	0.086993243	-0.023255814	0.074074074	0.096654275	0.079840319	0.249466951	0.2	nan
0.279801325	0.334916865	0.076013514	-0.043604651	0.018518519	0.029739777	0.031936128	0.28358209	0.04375	nan
0.132450331	0.342042755	0.054054054	0.055232558	0.013374486	-0.008364312	0.003992016	0.208955224	0.025	nan
0.221854305	0.318289786	0.040540541	0.031976744	-0.002057613	0.007434944	-0.001996008	0.023454158	0.05	nan
0.117549669	0.083135392	0.037162162	-0.020348837	0.002057613	-0.018587361	0	0.004264392	0.05	nan
0.026490066	0	0.021114865	-0.081395349	-0.004115226	-0.026022305	-0.001996008	-0.013859275	0	nan
-0.001655629	-0.121140143	0.010135135	-0.034883721	-0.020576132	-0.039033457	0	0	0	nan
];

B=inpaint_nans(B);

xdist=[0	2	4	6	8	10	12	14 16	20];
ydist=[0 2 4 6 8 10 12 16 20];


w     = 3;   % Size of the sliding window (same number of cols and rows in this case)
% Extrapolate values for current window
[Nr,Nc] = size(A);
Nextra  = 0.5*(w-1);
Ap      = interp2(1:Nc,1:Nr,A,-Nextra+1:Nc+Nextra,(-Nextra+1:Nr+Nextra).','makima');    % 2D extrapolation must use 'spline' or 'makima' interpolation
% Smooth data with sliding window
H  = ones(w)./w^2;                      % The 2D averaging filter
SDS  = filter2(H,Ap,'valid'); 

Ap      = interp2(1:Nc,1:Nr,B,-Nextra+1:Nc+Nextra,(-Nextra+1:Nr+Nextra).','makima');    % 2D extrapolation must use 'spline' or 'makima' interpolation
SDS2  = filter2(H,Ap,'valid'); 

 figure; 
 ax1=subplot(2,1,1); contourf(xdist,ydist,atan(SDS),1000,'edgecolor','none'); axis equal; colormap(ax1,brewermap([],'Blues')); 
 hold on; contour(xdist,ydist,SDS,[0.04 0.05],'LineColor', 'k');
 
 %caxis([0 max(max(SDS))]);
 ax2=subplot(2,1,2); contourf(xdist,ydist,atan(SDS2),1000,'edgecolor','none'); axis equal; colormap(ax2,brewermap([],'Reds')); %caxis([min() max(max(SDS2))]);
 hold on; contour(xdist,ydist,SDS2,[0.04 0.05],'LineColor', 'k');

 
 %% exp 4
clear all;

A=[0.532488114	0.108766234	0.453333333	0.339608434	0.525872443	0.592991914	0.41280654	0.418401937	0.710227273	0.582294264
0.190174326	0.12012987	0.235	0.121987952	0.312876053	0.407008086	0.205722071	0.221549637	0.645454545	0.481296758
0.099841521	0.125811688	0.113333333	0.027108434	0.120336943	0.227762803	0.068119891	0.092009685	0.275	0.179551122
0.0681458	0.097402597	0.083333333	0.036144578	0.058965102	0.198787062	0.017711172	0.084745763	0.129545455	0.041895262
0.045958796	0.073863636	0.063333333	0.016566265	0.051744886	0.180592992	-0.020435967	0.060532688	0.068181818	0.029800499
0.038034865	0.00487013	0.058333333	0.012048193	0.044524669	0.004043127	-0.024523161	0.001815981	0.023863636	0.026184539
0.030110935	-0.017857143	0.046666667	0.006024096	0.038507822	0	-0.019073569	0.013317191	0.009090909	0.024688279
0.017432647	-0.019480519	0.033333333	0	0.030084236	-0.018867925	-0.008174387	0.00968523	0.001136364	0.017456359
0.00792393	0	0	0.134789157	0.025270758	-0.010781671	-0.01226158	0.003631961	0.007954545	0.00872818
];

B=[0.629101284	0.667574932	0.203852327	0.379710145	0.587591241	0.632678133	0.62745098	0.541758242	0.172413793	0.00729927
0.235378031	0.559264305	0.088282504	0.275362319	0.415450122	0.464987715	0.60130719	0.424175824	0.060344828	0.047445255
0.17189729	0.371934605	0.040128411	0.046376812	0.164233577	0.127764128	0.572984749	0.307692308	-0.017241379	0.087591241
0.10128388	0.33106267	0.001605136	0.003623188	0.085158151	-0.008599509	0.54248366	0.156043956	0.002155172	0.102189781
0.064194009	0.302452316	0.012841091	-0.046376812	0.055961071	-0.029484029	0.562091503	0.017582418	-0.00862069	-0.047445255
0.031383738	-0.053133515	-0.04975923	-0.049275362	0.025547445	0.00982801	0.296296296	-0.134065934	0.025862069	-0.010948905
0.017118402	-0.068119891	-0.055377207	-0.052173913	0.02189781	0.013513514	0.005446623	-0.171428571	0	-0.012773723
0.004279601	-0.099455041	-0.04975923	-0.075362319	0.008515815	0.014742015	-0.052287582	-0.118681319	-0.915948276	-0.01459854
0	-0.034059946	0	0	-0.01946472	0.004914005	-0.069716776	-0.063736264	-0.344827586	0.040145985
];

%B=inpaint_nans(B);

xdist=[2 4	6 8 10	12	14 16 18 20];
ydist=[0 2 4 6 8 10 12 16 20];


w     = 4;   % Size of the sliding window (same number of cols and rows in this case)
% Extrapolate values for current window
[Nr,Nc] = size(A);
Nextra  = 0.5*(w-1);
Ap      = interp2(1:Nc,1:Nr,A,-Nextra+1:Nc+Nextra,(-Nextra+1:Nr+Nextra).','makima');    % 2D extrapolation must use 'spline' or 'makima' interpolation
% Smooth data with sliding window
H  = ones(w)./w^2;                      % The 2D averaging filter
SDS  = filter2(H,Ap,'valid'); 

Ap      = interp2(1:Nc,1:Nr,B,-Nextra+1:Nc+Nextra,(-Nextra+1:Nr+Nextra).','makima');    % 2D extrapolation must use 'spline' or 'makima' interpolation
SDS2  = filter2(H,Ap,'valid'); 

 figure; 
 ax1=subplot(2,1,1); contourf(xdist,ydist,(SDS2),1000,'edgecolor','none'); axis normal; colormap(ax1,brewermap([],'Blues')); 
 hold on; contour(xdist,ydist,SDS2,[0.04 0.05],'LineColor', 'k');
 
 %caxis([0 max(max(SDS))]);
 ax2=subplot(2,1,2); contourf(xdist,ydist,(SDS),1000,'edgecolor','none'); axis normal; colormap(ax2,brewermap([],'Reds')); %caxis([min() max(max(SDS2))]);
 hold on; contour(xdist,ydist,SDS,[0.04 0.05],'LineColor', 'k');
%% run 1 distance and plot amp vs IDI

Valecho1=[]; Valecho2=[]; Val=[]; Val2=[]; Valraw1=[]; Valraw2=[];
samplerate1=20000; AUX11=[];
tic
for i=1:size(fileN,2)
    load([direfinal, '\', files2(fileN(i)).name])
    if OP==0
        EODtime=eval([files2(fileN(i)).name(1:end-4),'_Ch3.values']);
        LFP=eval([files2(fileN(i)).name(1:end-4),'_Ch2.values']);
    else
        EODtime=eval(['V',files2(fileN(i)).name(1:end-4),'_Ch3.values']);
        LFP=eval(['V',files2(fileN(i)).name(1:end-4),'_Ch2.values']);     
    end
    % Mfish=eval(['V',files2(vidnum(j)).name(1:end-4),'_Ch5.values']);
    
    if OP==0
        [value3,sample3]=findpeaks(EODtime ,'MINPEAKHEIGHT',0.5,'MINPEAKDISTANCE',90);
        [value4,sample4]=findpeaks(EODtime ,'MINPEAKHEIGHT',4.5,'MINPEAKDISTANCE',200);
    elseif OP==1
        [value3,sample3]=findpeaks(LFP ,'MINPEAKHEIGHT',0.16,'MINPEAKDISTANCE',90);
        [value4,sample4]=findpeaks(LFP ,'MINPEAKHEIGHT',0.55,'MINPEAKDISTANCE',200);
    elseif OP==2
        [value3,sample3]=findpeaks(LFP ,'MINPEAKHEIGHT',0.055,'MINPEAKDISTANCE',90);
        a=1; sample4=[];
        for k=1:size(sample3,1)
            try
                if max(LFP(sample3(k)+120:sample3(k)+221))>=0.013
                    sample4(a,1)=sample3(k);
                    a=a+1;
                end
            end
        end
    end
    %figure; subplot(2,1,1); plot((1:1:size(EODtime,1))/samplerate1,EODtime);  hold on; plot(sample3/samplerate1,1,'or'); hold on; plot(sample4/samplerate1,1,'ob');
    figure; subplot(2,1,1); plot((1:1:size(EODtime,1))/samplerate1,LFP);  hold on; plot(sample3/samplerate1,0.01,'or'); hold on; plot(sample4/samplerate1,0.01,'ob');
    
    LFPAm_1=[]; LFPAm_1echo=[]; LFPAm_2=[]; LFPAm_2echo=[]; LFPraw_1=[]; LFPraw_2=[]; time_sample4=[];  LFPAm_2echo2=[]; time_sample3=[];
            LFPAm_1echo2=[];
     
    for k=1:size(sample4,1)
        sample3(sample3(:)==sample4(k))=[];
    end
    a=1; b=1;
    for j=1:size(sample3,1)
        [k,dist] = dsearchn(sample3(j),sample4); [val,idx]=min(dist);
        AUX=[];
        if sample3(j)<=sample4(idx)
            try
                AUX=sample3(j)-sample4(idx-1);
            catch
                AUX=500;
            end
        else
            AUX=sample3(j)-sample4(idx);
        end
        try
            time_sample3(j)=AUX/samplerate1;
            LFPAm_1echo2(j)=min(LFP(sample4(j)+20:sample4(j)+100))-LFP(sample3(j)-25);
        catch
            time_sample3(j)=nan;
            LFPAm_1echo2(j)=nan;
        end
        
        
        if AUX<=300
            LFPAm_1echo(a)=min(LFP(sample3(j)+20:sample3(j)+100)); a=a+1;
        else
            try
                LFPAm_1(b)=min(LFP(sample3(j)+20:sample3(j)+100));
                LFPraw_1(1:81,b)=(LFP(sample3(j)+20:sample3(j)+100));
                b=b+1;
            end
        end
        
    end
    
    
    a=1; b=1;
    for j=1:size(sample4,1)
        [k,dist] = dsearchn(sample4(j),sample3); [val,idx]=min(dist);
        AUX=[];
        if sample4(j)<=sample3(idx)
            try
                AUX=sample4(j)-sample3(idx-1);
            catch
                AUX=500;
            end
        else
            AUX=sample4(j)-sample3(idx);
        end
        try
            time_sample4(j)=AUX/samplerate1;
            LFPAm_2echo2(j)=min(LFP(sample4(j)+20:sample4(j)+100))-LFP(sample4(j)-25);
        catch
            time_sample4(j)=nan;
            LFPAm_2echo2(j)=nan;
        end
        
        
        if AUX<=300
            LFPAm_2echo(a)=min(LFP(sample4(j)+20:sample4(j)+100)); a=a+1;
        else
            try
                LFPAm_2(b)=min(LFP(sample4(j)+20:sample4(j)+100));
                LFPraw_2(1:81,b)=(LFP(sample4(j)+20:sample4(j)+100));
                b=b+1;
%             catch
%                 LFPAm_2(b)=min(LFP(sample4(j)+20:sample4(j)+50));
%                 LFPraw_2(1:81,b)=nan;
%                 b=b+1;
            end
        end
    end
    
    Valecho1(i)=nanmedian(LFPAm_1echo);
    Valecho2(i)=nanmedian(LFPAm_2echo);
    
    Val1(i)=nanmedian(LFPAm_1);
    Val2(i)=nanmedian(LFPAm_2);
    
    Valraw1(1:81,i)=nanmedian(LFPraw_1,2);
    Valraw2(1:81,i)=nanmedian(LFPraw_2,2);
   
    a=1; M1=[];
    for z=1:size(sample3,1) %calculate IDI with fish and mimic
        try
            [idx2,idx]=min(abs(sample4-sample3(z)));
            if sample4(idx)>=sample3(z)
                M1(a,1)=(sample4(idx-1)-sample3(z))/samplerate1;
                M1(a,2)=(sample4(idx)-sample3(z))/samplerate1;
            else
                M1(a,1)=(sample4(idx)-sample3(z))/samplerate1;
                M1(a,2)=(sample4(idx+1)-sample3(z))/samplerate1;
            end
            a=a+1;
        end
    end
    
    
    AUX111=reshape(M1,[1,size(M1,1)*size(M1,2)]);
    AUX11=[AUX11,AUX111];
    %figure; plot(time_sample4,abs(LFPAm_2echo2)/abs(mean(LFPAm_2echo2)),'.'); xlim([0 0.2])
end
toc

%figure; plot(time_sample4,LFPAm_2echo2,'.'); xlim([0 0.2])
%figure; plot(time_sample3,LFPAm_1echo2,'.'); xlim([0 0.2])


